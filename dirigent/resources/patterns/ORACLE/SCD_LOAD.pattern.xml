<?xml version="1.0" encoding="UTF-8"?>
<tns:Pattern name="" xmlns:tns="http://www.example.org/dirigent-pattern/"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.example.org/dirigent-pattern/ ../dirigent-pattern.xsd ">
	<Documentation>Documentation</Documentation>
	
	<PatternStep ignoreErrors="false" name="Drop Stage Table" type="File">
		<Parameter name="fileName" value="data-model/SCD/${element.name}.doscd.sql" />
		<Parameter name="mode" value="overwrite" />
		<Template><![CDATA[    
		DROP TABLE STG_${element.targetTable.name};
    ]]>
    </Template>
	</PatternStep>
	
	<PatternStep ignoreErrors="false" name="Create Stage Table" type="File">
		<Parameter name="fileName" value="data-model/SCD/${element.name}.doscd.sql" />
		<Parameter name="mode" value="append" />
		<Template><![CDATA[    
		CREATE TABLE STG_${element.targetTable.name}
		(
			${element.targetColumnList}
		)
		as
		${element.SQLQuery};
    ]]>
    </Template>
	</PatternStep>
	
	<PatternStep ignoreErrors="false" name="Insert new objects"
		type="File">
		<Parameter name="fileName" value="data-model/SCD/${element.name}.doscd.sql" />
		<Parameter name="mode" value="append" />
		<Template><![CDATA[    
INSERT INTO ${element.targetTable.fullName} 
	(${element.targetColumnList},
    	CUST_VALID_FROM_DATETIME,
		CUST_VALID_TO_DATETIME,
		CUST_CURRENT_FLAG,
		CUST_UPDATED_DATETIME
    ) 
    values
    (
   		stage.*,
   		sysdate,
   		to_date('1.1.3000','dd.mm.yyyy'),
   		'Y',
   		sysdate
   		from STG_${element.targetTable.name} stage
   		where
   		
	#foreach(${column} in ${element.targetTable.columns})
		#if(${column.properties.scdColumnType}=="naturalKey")
			stage.${column.name} NOT IN 
			(
				select target.${column.name} from ${element.targetTable.fullName} target
			)
		#end
	#end
   	
   	);
    ]]>
    </Template>
	</PatternStep>
	
	<PatternStep ignoreErrors="false" name="Update existing objects"
		type="File">
		<Parameter name="fileName" value="data-model/SCD/${element.name}.doscd.sql" />
		<Parameter name="mode" value="append" />
		<Template><![CDATA[    

    ]]>
    </Template>
	</PatternStep>
</tns:Pattern>
