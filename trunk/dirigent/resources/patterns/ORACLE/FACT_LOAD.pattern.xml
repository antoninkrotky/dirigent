<?xml version="1.0" encoding="UTF-8"?>
<tns:Pattern xmlns:tns="http://www.example.org/dirigent-pattern/"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.example.org/dirigent-pattern/ ../dirigent-pattern.xsd ">
	<Documentation>TODO</Documentation>

	<PatternStep ignoreErrors="true" name="Drop Stage Table" type="File">
		<Parameter name="fileName" value="data-model/L2/${element.name}.factLoad.sql" />
		<Parameter name="mode" value="overwrite" />
		<Template><![CDATA[    
		DROP TABLE STG_${element.targetTable.name}
    ]]>
    </Template>
	</PatternStep>

	<PatternStep name="Create Stage Table" type="File">
	<Parameter name="fileName" value="data-model/L2/${element.name}.factLoad.sql" />
	<Parameter name="mode" value="append" />
		<Template><![CDATA[    
		CREATE TABLE STG_${element.targetTable.name}
		(
			${element.targetColumnList}
		)
		as
		${element.SQLQuery}
    ]]>
    </Template>
	</PatternStep>

	<PatternStep name="Dimension Lookup Update" type="File">
	<Parameter name="fileName" value="data-model/L2/${element.name}.factLoad.sql" />
	<Parameter name="mode" value="append" />
		<Template><![CDATA[
		#set( $naturalKeyProperty = "naturalKey" )
		    
		UPDATE ${element.targetTable.name} target
		SET
		#set($comma = false)
		#foreach( ${dim} in ${element.targetTable.relatedDimensions} )
			#if($comma),#else#set($comma = true)#end
			target.${dim.alias}_KEY = (
				SELECT d2.${dim.alias}_KEY 
				FROM ${dim.name} d1 JOIN ${dim.name} d2 ON (
					${utils.getWhereClausule(${dim.getColumnListBySCDType(${naturalKeyProperty})}, "=", "AND", "d1", "d2")}
				)
				WHERE d1.${dim.alias}_KEY = target.${dim.alias}_KEY AND d2.${dim.alias}_CURRENT_FLAG = 'Y'
			)
		#end
		WHERE EXISTS (
			SELECT *
			FROM ${element.targetTable.name} fact
				#set($i = 1)
				#set($res = "")
				#foreach( ${dim} in ${element.targetTable.relatedDimensions} )
					JOIN ${dim.name} d${i} ON (fact.${dim.alias}_KEY = d${i}.${dim.alias}_KEY)
					#set($res = ${utils.joinStrings(${res}, "d${i}.${dim.alias}_CURRENT_FLAG = 'N'", "OR")})
					#set($i = $i + 1)
				#end
			WHERE fact.${element.targetTable.alias}_KEY = target.${element.targetTable.alias}_KEY AND ($res)
		)
    ]]>
    </Template>
	</PatternStep>

	<PatternStep name="Merge" type="File">
	<Parameter name="fileName" value="data-model/L2/${element.name}.factLoad.sql" />
	<Parameter name="mode" value="append" />
		<Template><![CDATA[ 
	MERGE INTO ${element.targetTable.name} target
	USING
		(
		SELECT *
		FROM STG_${element.targetTable.name}
		MINUS
			(
			SELECT ${element.targetColumnList}
			FROM ${element.targetTable.fullName}
			)
		) stage
	ON
		(
			#set($res = "")
			#foreach( ${dim} in ${element.targetTable.relatedDimensions} )
				#set($res = ${utils.joinStrings($res, "target.${dim.alias}_KEY = stage.${dim.alias}_KEY", " AND ")})
			#end
			${res}
			#*${utils.getWhereClausule(${element.targetTable.relatedDimensionsColumn}, "=", "AND", "target", "stage")}*#
		)
	WHEN MATCHED THEN
		UPDATE
		SET
		${utils.getWhereClausule(${element.targetTable.columns}, "=", ",", "target", "stage")}
		
	WHEN NOT MATCHED THEN
		INSERT
		(
			${element.targetColumnList},
			${element.targetTable.alias}_KEY
    	)
    	VALUES
    	(
    		#set($res = "")
    		#foreach( ${col} in ${element.columnMappings} )#set($res = ${utils.joinStrings(${res}, "stage.${col.column.name}", ",")})#end
    		
			#*
			#foreach( ${column} in ${element.targetTable.columns} )#set($res = ${utils.joinStrings(${res}, "stage.${column.name}", ",")})#end
			#foreach( ${column} in ${element.targetTable.relatedDimensions} )#set($res = ${utils.joinStrings(${res}, "stage.${column.alias}_KEY", ",")})#end
			*#
			#set($res = ${utils.joinStrings(${res}, "${element.targetTable.alias}_SEQ.NEXTVAL", ",")})
			$res
    	)
    ]]>
    </Template>
	</PatternStep>
</tns:Pattern>
